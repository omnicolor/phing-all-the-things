<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>PHING ALL THE THINGS!</title>
    <link rel="stylesheet" href="deck.js/core/deck.core.css">
    <link rel="stylesheet" href="deck.js/themes/style/web-2.0.css">
    <link rel="stylesheet" href="deck.js/themes/transition/horizontal-slide.css">
    <link rel="stylesheet" href="deck.js/extensions/status/deck.status.css">
    <link rel="stylesheet" href="google-code-prettify/src/prettify.css">
    <link rel="stylesheet/less" href="styles.less">
    <script src="less-1.3.1.min.js"></script>
    <script src="deck.js/modernizr.custom.js"></script>
</head>

<body>

<section class="slide title">
    <img alt="Phing All The Things!" class="centered"
            src="images/phing-the-things.jpg">
</section>

<section class="slide about-me">
    <div class="centered">
        <img alt="Omni Adams" class="pull-left" src="images/omni-simpson.jpg">
        <ul class="pull-right">
            <li>Omni Adams</li>
            <li>@omnicolor</li>
            <li>http://omni-spot.blogspot.com</li>
            <li>omni@digitaldarkness.com</li>
        </ul>
    </div>
    <ul class="note">
        <li>1st, a little about me</li>
        <li>my name is</li>
        <li>find me on the twitter</li>
        <li>check out my blog</li>
        <li>feel free to email me</li>
        <li>This slide will be repeated at the end of this session</li>
        <li>And I will put the slides up somewhere as well</li>
        <li>a few things about this talk</li>
        <li>I try to be funny, it's okay to laugh</li>
        <li>If you're easily offended</li>
        <li>Feel free to ask questions</li>
        <li>Don't be scared by the number in the lower right</li>
    </ul>
</section>

<section class="slide">
    <h1>Lazy development</h1>
    <ul class="note">
        <li>I specialize in lazy development</li>
        <li>What is lazy development you ask?</li>
    </ul>
</section>

<section class="slide lazy-development">
    <img alt="sleeping cat" class="centered"
        src="images/scriptlet-sleeping.jpg">
    <ul class="note">
        <li>Lazy development lets you stop wasting time</li>
        <li>get back to what's important</li>
        <li>like petting your cat</li>
        <li>or taking a nap</li>
        <li>Phing lets me work hard only once for each task</li>
        <li>Then I let the computer repeat that task</li>
        <li>It turns out that computers are much better at repetition</li>
    </ul>
</section>

<section class="slide dry-0">
    <h1>Stay <span>DRY</span></h1>
    <ul class="note">
        <li>Hopefully you've heard DRY</li>
        <li>Don't repeat yourself</li>
        <li>Lemme say that again</li>
        <li>DO NOT REPEAT YOURSELF</li>
        <li>If you find yourself looking up command line flags</li>
        <li>even twice, it's a candidate for automation</li>
    </ul>
</section>

<section class="slide dry-1">
    <img alt="http://ardalis.com/DRY---Don%E2%80%99t-Repeat-Yourself---Motivator"
        class="centered" src="images/dont_repeat.jpg">
    <ul class="note">
        <li>Start small with phing</li>
        <li>Choose something you do all the time</li>
        <li>I assume you're all writing tests...</li>
        <li>You are all writing tests, right?</li>
        <li>If not, you better be in Chris Hartjes later today</li>
    </ul>
</section>

<section class="slide">
    <pre class="prettyprint">
    &lt;?xml version="1.0" encoding=&quot;UTF-8&quot;?&gt;
    &lt;project name=&quot;phing-the-things&quot; default=&quot;test&quot;&gt;
        &lt;target name=&quot;test&quot;&gt;
            &lt;exec executable="phpunit" passthru="true"
                    checkreturn="true" /&gt;
        &lt;/target&gt;
    &lt;/project&gt;</pre>
    <ul class="note">
        <li>So we'll start with getting phing to run phpunit</li>
        <li>Here's a really simple build.xml file</li>
        <li>Your most basic phing building block is the target</li>
        <li>Targets do things</li>
        <li>... or do logic</li>
        <li>... or set variables (which we'll get to)</li>
        <li>In this case the target calls one task: exec</li>
        <li>That calls the phpunit executable</li>
    </ul>
</section>

<section class="slide">
    <pre class="prettyprint">
    <span class="highlight">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
    &lt;project name=&quot;phing-the-things&quot; default=&quot;test&quot;&gt;
        &lt;target name=&quot;test&quot;&gt;
            &lt;exec executable="phpunit" passthru="true"
                    checkreturn="true" /&gt;
        &lt;/target&gt;
    &lt;/project&gt;</pre>
    <ul class="note">
        <li>First, we have the standard XML stuff</li>
        <li>phing is all enterprisey and uses XML</li>
        <li>Hey, it could be worse, it could be java</li>
        <li>Phing is a pretty close port of Apache ANT, which uses XML</li>
    </ul>
</section>

<section class="slide">
    <pre class="prettyprint">
    &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
    <span class="highlight">&lt;project name=&quot;phing-the-things&quot; default=&quot;test&quot;&gt;</span>
        &lt;target name=&quot;test&quot;&gt;
            &lt;exec executable="phpunit" passthru="true"
                    checkreturn="true" /&gt;
        &lt;/target&gt;
    <span class="highlight">&lt;/project&gt;</span></pre>
    <ul class="note">
        <li>And you have the project tags that surround your tasks</li>
        <li>I'll leave these out of the future slides</li>
    </ul>
</section>

<section class="slide">
    <pre class="prettyprint">
    &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
    &lt;project name=&quot;phing-the-things&quot; default=&quot;test&quot;&gt;
        <span class="highlight">&lt;target name=&quot;test&quot;&gt;</span>
            &lt;exec executable="phpunit" passthru="true"
                    checkreturn="true" /&gt;
        <span class="highlight">&lt;/target&gt;</span>
    &lt;/project&gt;</pre>
    <ul class="note">
        <li>Then the actual target tag</li>
        <li>We'll cover this more in depth as well later</li>
        <li>For now, know that the name is what you use to call it with</li>
    </ul>
</section>

<section class="slide">
    <pre class="prettyprint">
    &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
    &lt;project name=&quot;phing-the-things&quot; default=&quot;test&quot;&gt;
        &lt;target name=&quot;test&quot;&gt;
            <span class="highlight">&lt;exec executable="phpunit" passthru="true"
                    checkreturn="true" /&gt;</span>
        &lt;/target&gt;
    &lt;/project&gt;</pre>
    <ul class="note">
        <li>Finally, the exec tag that actually does the work</li>
        <li>This is called a task in phing terminology</li>
        <li>There are a bunch of fancy tasks pre-written</li>
        <li>You can write new ones</li>
        <li>exec is a very powerful task if you're CLI-inclined</li>
        <li>I'll show some more complicated execs later</li>
        <li>There is a phpunit task, but it is pretty limited</li>
    </ul>
</section>

<section class="slide">
<pre class="cli">phing-the-things$ phing test
<span class="notice">Buildfile: /Users/Omni/phing-example/build.xml
 [property] Loading /Users/Omni/phing-example/build.properties</span>

phing-example &gt; test:

PHPUnit 3.7.13 by Sebastian Bergmann.

Configuration read from /Users/Omni/phing-example/phpunit.xml

..............................
Time: 0 seconds, Memory: 7.25Mb

<span class="invert-pass">OK (30 tests, 52 assertions)</span>

<span class="pass">BUILD FINISHED
Total time: 0.3155 seconds</span></pre>
    <ul class="note">
        <li>Now, if you type phing test it will run your task</li>
        <li>and hopefully you'll get some pretty success messages</li>
    </ul>
</section>

<section class="slide">
<pre class="cli"><span class="invert-fail">F</span>.............................
Time: 0 seconds, Memory: 7.25Mb

There was 1 failure:

1) GitTest::testGetCommitInfo
LOL cats have clogged the tubes!
/Users/Omni/phing-example/tests/GitTest.php:51

<span class="invert-fail">FAILURES!
Tests: 30, Assertions: 51, Failures: 1.</span>
<span class="fail">Execution of target "test" failed for the following reason: /Users/Omni/phing-example/build.xml:102:46: Task exited with code 1

BUILD FAILED
/Users/Omni/phing-example/build.xml:102:46: Task exited with code 1
Total time: 0.5653 seconds</span></pre>
    <ul class="note">
        <li>If you have a failing test, you'll get something more like this</li>
        <li>Notice that it tells you the exit code</li>
        <li>For those of you not familiar with exit codes</li>
    </ul>
</section>

<section class="slide">
    <pre class="prettyprint">    &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
    &lt;project name=&quot;phing-the-things&quot; <span class="highlight">default=&quot;test&quot;</span>&gt;
        &lt;target name=&quot;test&quot;&gt;
            &lt;exec executable="phpunit" passthru="true"
                    checkreturn="true" /&gt;
        &lt;/target&gt;
    &lt;/project&gt;</pre>
    <ul class="note">
        <li>Note that there's a default attribute on your project</li>
        <li>If you just run phing from the command line</li>
        <li>without any arguments, this is what it will run</li>
        <li>I never do this, but phing will complain if default isn't set</li>
    </ul>
</section>

<section class="slide">
    <pre class="prettyprint">
    &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
    &lt;project name=&quot;phing-the-things&quot; default=&quot;test&quot;&gt;
        &lt;target name=&quot;test&quot;&gt;
            &lt;exec executable="phpunit" passthru="true"
                    <span class="highlight strike">checkreturn="true"</span> /&gt;
        &lt;/target&gt;
    &lt;/project&gt;</pre>
    <ul class="note">
        <li>Remember that checkreturn attribute earlier?</li>
        <li>Here's what happens if you leave it off</li>
        <li>Or you set it to false</li>
    </ul>
</section>

<section class="slide">
<pre class="cli"><span class="invert-fail">F</span>.............................

Time: 0 seconds, Memory: 7.25Mb

There was 1 failure:

1) GitTest::testGetCommitInfo
LOL cats have clogged the tubes!

/Users/Omni/phing-example/tests/GitTest.php:51

<span class="invert-fail">FAILURES!
Tests: 30, Assertions: 51, Failures: 1.</span>

<span class="pass">BUILD FINISHED

Total time: 0.5619 seconds</span></pre>
    <ul class="note">
        <li>The PHPunit task should fail a build if it fails</li>
        <li>Here you can see the tests failed, but the build passed</li>
        <li>The phpunit task fails the build, but the exec doesn't</li>
    </ul>
</section>

<section class="slide lolwut-phpunit">
    <img alt="LOLWUT?" class="centered" src="images/lolwut.jpg">
    <ul class="note">
        <li>
            So if you have to add this extra attribute to get sane behavior...
        </li>
        <li>There are some places where you might not want to fail the build</li>
        <li>like building documentation for example</li>
        <li>The phpunit task is limited in what you can configure</li>
    </ul>
</section>

<section class="slide phpunit-vs-exec">
    <ul class="content">
        <li>strict</li>
        <li>colors</li>
        <li>groups</li>
        <li>command line flags</li>
    </ul>
    <ul class="note">
        <li>Here's some things that the phpunit task doesn't seem to support</li>
        <li>strict for catching tests with no assertions</li>
        <li>colors for prettier output</li>
        <li>groups for targetting tests</li>
        <li>and command line flags for changing behavior at run time</li>
        <li>If you don't care about these, use the real task</li>
    </ul>
</section>

<section class="slide">
    <pre class="prettyprint">
    &lt;target name=&quot;test&quot;&gt;
        &lt;exec executable=&quot;phpunit&quot; passthru=&quot;true&quot;
                checkreturn=&quot;true&quot;&gt;
            <span class="highlight">&lt;arg value=&quot;--exclude-group=integration&quot; /&gt;</span>
        &lt;/exec&gt;
    &lt;/target&gt;</pre>
    <ul class="note">
        <li>One argument I like to be able to include</li>
        <li>exclude-group (or include-group)</li>
        <li>Lets you target tests with @group annotations</li>
        <li>So you can organize your tests a bit</li>
        <li>Like smoke, integration, selenium, or whatever</li>
    </ul>
</section>

<section class="slide">
    <pre class="prettyprint">
    &lt;target name=&quot;test&quot;&gt;
        &lt;exec executable=&quot;phpunit&quot; passthru=&quot;true&quot;
                checkreturn=&quot;true&quot;&gt;
            <span class="highlight">&lt;arg value=&quot;${phpunitFlag}&quot; /&gt;</span>
        &lt;/exec&gt;
    &lt;/target&gt;</pre>
    <ul class="note">
        <li>Another that's pretty helpful is a flag</li>
        <li>This lets you modify phpunit behavior while running phing</li>
        <li>to run just a single test file for example</li>
    </ul>
</section>

<section class="slide properties">
    <img alt="Find X" class="centered" src="images/findX.gif">
    <ul class="note">
        <li>Variables are called properties in Phing</li>
        <li>There's a few ways of setting them</li>
    </ul>
</section>

<section class="slide">
    <pre class="prettyprint">
    &lt;property name=&quot;phpunitFlag&quot; value=&quot;--group=smoke&quot; /&gt;
    &lt;property name="&quot;outputDir&quot; value=&quot;./docs&quot; /&gt;</pre>
    <ul class="note">
        <li>One way is with a property line in your build file</li>
        <li>This is useful for setting paths to things</li>
        <li>For example, you can default a path to a sane value</li>
        <li>but allow other developers to easily override it if needed</li>
        <li>We'll get into how a little later</li>
    </ul>
</section>

<section class="slide">
    <pre class="cli">phing-the-things$ phing test -DphpunitFlag=--group=smoke
<span class="notice">Buildfile: /Users/Omni/phing-example/build.xml
 [property] Loading /Users/Omni/phing-example/build.properties</span>

phing-example &gt; test:

PHPUnit 3.7.13 by Sebastian Bergmann.

Configuration read from /Users/Omni/phing-example/phpunit.xml

........
Time: 0 seconds, Memory: 7.25Mb

<span class="invert-pass">OK (8 tests, 12 assertions)</span>

<span class="pass">BUILD FINISHED
Total time: 0.1058 seconds</span></pre>
    <ul class="note">
        <li>Another way is from the command line</li>
        <li>Yeah, it's ugly</li>
        <li>That's the Java heritage for you</li>
    </ul>
</section>

<section class="slide even-smaller">
    <pre class="no-bottom">composer=/opt/composer.phar
server1.user=oadams
server1.url=www.example.lan</pre>
    <pre class="prettyprint">    &lt;property file=&quot;build.properties&quot; /&gt;
    &lt;target name=&quot;properties-example&quot;&gt;
        &lt;exec executable=&quot;${composer}" /&gt;
        &lt;exec executable=&quot;ssh" passthru="true"&gt;
            &lt;arg value=&quot;-t&quot; /&gt;
            &lt;arg value=&quot;${server1.user}@${server1.url}&quot; /&gt;
            &lt;arg value=&quot;sudo /sbin/service httpd restart&quot; /&gt;
        &lt;/exec&gt;
    &lt;/target&gt;</pre>
    <ul class="note">
        <li>Another way of setting properties is build.properties</li>
        <li>Simple name equals value text file</li>
        <li>Probably should be ignored in your source control</li>
        <li>At the top you see an example build.properties</li>
        <li>Each of these are usable in your build file</li>
        <li>This first exec shows how to set where your composer.phar is</li>
        <li>
            The second shows using a user and hostname to restart apache with
            SSH
        </li>
        <li>We'll get more into this sort of advanced magic later</li>
    </ul>
</section>

<section class="slide first-things-first">
    <div id="first">first</div>
    <div id="things">things</div>
    <div id="second">first</div>
    <ul class="note">
        <li>One thing that can easily trip you up</li>
        <li>Properties are mostly immutable</li>
        <li>except when they're not</li>
        <li>There are a few exceptions to this rule, and we'll get to those</li>
    </ul>
</section>

<section class="slide">
    <pre># build.properties
foo=test
bar=test</pre>
    <pre class="prettyprint">    &lt;property name=&quot;foo&quot; value=&quot;bar&quot; /&gt;
    &lt;property file=&quot;build.properties&quot; /&gt;
    &lt;property name=&quot;mitz&quot; value=&quot;fah&quot; /&gt;</pre>
    <ul class="note">
        <li>If you don't put your build.properties file first, it doesn't</li>
        <li>
            So in this case, you might think build.properties sets both to test
        </li>
        <li>But the foo property has already been set, so it is still 'bar'</li>
        <li>While the mitz value is set to 'test'</li>
        <li>This does let you control which variables can be overridden</li>
        <li>If you set some before build.properties is included, they're set</li>
        <li>Those set after it's included can be changed by the user</li>
    </ul>
</section>

<section class="slide filesets">
    <img alt="Smelly feet" class="centered" src="images/cat-feet.jpg">
    <ul class="note">
        <li>Any of y'all use PHP code sniffer?</li>
        <li>It's a tool that sniffs your code to find possible problems</li>
        <li>
            If you use any third-party libraries, your phpcs may have irrelevant
            warnings
        </li>
        <li>One way to fix that is with filesets</li>
    </ul>
</section>

<section class="slide patternset even-smaller">
    <pre class="prettyprint">    &lt;patternset id=&quot;<span class="highlight">files</span>&quot;&gt;
        &lt;include name=&quot;**/*.php&quot; /&gt;
        &lt;exclude name=&quot;third-party/**&quot; /&gt;
        &lt;exclude name=&quot;vendor/**&quot; /&gt;
    &lt;/patternset&gt;
    &lt;target name=&quot;phpcs&quot;&gt;
        &lt;phpcodesniffer standard=&quot;./coding_rules.xml&quot; format=&quot;full&quot;
                showWarnings=&quot;true&quot;&gt;
            &lt;fileset dir=&quot;.&quot;&gt;
                &lt;patternset refid=&quot;<span class="highlight">files</span>&quot; /&gt;
            &lt;/fileset&gt;
        &lt;/phpcodesniffer&gt;
    &lt;/target&gt;</pre>
    <ul class="note">
        <li>Here we define a patternset and call it files</li>
        <li>include everything in our project directory that ends in php</li>
        <li>exclude everything in 3rd-party and any composer...</li>
        <li>The fileset used in phpcs references the patternset we defined</li>
        <li>Very useful in this use case so you can run static...</li>
        <li>Most of the tools Germans write to say you're doing it wrong...</li>
        <li>This avoids running it on dependencies you don't maintain</li>
        <li>since composer dependencies might all use a different style</li>
    </ul>
</section>

<section class="slide apidoc">
    <img alt="Documentation" class="centered" src="images/documentation.jpg" />
    <ul class="note">
        <li>Then there's documentation...</li>
        <li>Anyone use PHPdoc to document their code?</li>
    </ul>
</section>

<section class="slide smaller">
    <pre class="prettyprint">    &lt;target name=&quot;document&quot; depends=&quot;require-docdir&quot;&gt;
        &lt;mkdir dir=&quot;${docdir}/api&quot; /&gt;
        &lt;exec executable=&quot;phpdoc&quot; passthru=&quot;true&quot;&gt;
            &lt;arg value=&quot;--directory=.&quot; /&gt;
            &lt;arg value=&quot;--ignore=vendor/*&quot; /&gt;
            &lt;arg value=&quot;--ignore=src/*&quot; /&gt;
            &lt;arg value=&quot;--progressbar&quot; /&gt;
            &lt;arg value=&quot;--target=${docdir}/api&quot; /&gt;
            &lt;arg value=&quot;--title=API documentation&quot; /&gt;
        &lt;/exec&gt;
    &lt;/target&gt;</pre>
    <ul class="note">
        <li>Again, there is a phpdocumentor2 task that does this natively</li>
        <li>But I want to talk about a few things here</li>
        <li>This is as good a task to use for some examples, right?</li>
    </ul>
</section>

<section class="slide smaller">
    <pre class="prettyprint">    &lt;target name=&quot;document&quot; depends=&quot;require-docdir&quot;&gt;
        <span class="highlight">&lt;mkdir dir=&quot;${docdir}/api&quot; /&gt;</span>
        &lt;exec executable=&quot;phpdoc&quot; passthru=&quot;true&quot;&gt;
            &lt;arg value=&quot;--directory=.&quot; /&gt;
            &lt;arg value=&quot;--ignore=vendor/*&quot; /&gt;
            &lt;arg value=&quot;--ignore=src/*&quot; /&gt;
            &lt;arg value=&quot;--progressbar&quot; /&gt;
            &lt;arg value=&quot;--target=${docdir}/api&quot; /&gt;
            &lt;arg value=&quot;--title=API documentation&quot; /&gt;
        &lt;/exec&gt;
    &lt;/target&gt;</pre>
    <ul class="note">
        <li>First, note that you can do more than one thing in a target</li>
        <li>
            Here, we're building documentation after we create a new directory
        </li>
        <li>You can add any number of tasks to a build target</li>
        <li>
            But obviously, you should refactor your build like any other code
        </li>
        <li>and keep your targets short and easy to read and understand</li>
    </ul>
</section>

<section class="slide smaller">
    <pre class="prettyprint">    &lt;target name=&quot;document&quot; depends=&quot;require-docdir&quot;&gt;
        &lt;mkdir dir=&quot;${docdir}/api&quot; /&gt;
        &lt;exec executable=&quot;phpdoc&quot; passthru=&quot;true&quot;&gt;
            <span class="highlight">&lt;arg value=&quot;--directory=.&quot; /&gt;</span>
            &lt;arg value=&quot;--ignore=vendor/*&quot; /&gt;
            &lt;arg value=&quot;--ignore=src/*&quot; /&gt;
            &lt;arg value=&quot;--progressbar&quot; /&gt;
            &lt;arg value=&quot;--target=${docdir}/api&quot; /&gt;
            &lt;arg value=&quot;--title=API documentation&quot; /&gt;
        &lt;/exec&gt;
    &lt;/target&gt;</pre>
    <ul class="note">
        <li>Second, notice how we pass in arguments to our exec call</li>
        <li>Everything in the arg value is actually quoted</li>
        <li>The upshot of this is that you can have spaces</li>
        <li>For example &rarr; you don't need</li>
    </ul>
</section>

<section class="slide smaller">
    <pre class="prettyprint">    &lt;target name=&quot;document&quot; depends=&quot;require-docdir&quot;&gt;
        &lt;mkdir dir=&quot;${docdir}/api&quot; /&gt;
        &lt;exec executable=&quot;phpdoc&quot; passthru=&quot;true&quot;&gt;
            &lt;arg value=&quot;--directory=.&quot; /&gt;
            &lt;arg value=&quot;--ignore=vendor/*&quot; /&gt;
            &lt;arg value=&quot;--ignore=src/*&quot; /&gt;
            &lt;arg value=&quot;--progressbar&quot; /&gt;
            &lt;arg value=&quot;--target=${docdir}/api&quot; /&gt;
            <span class="highlight">&lt;arg value=&quot;--title=API documentation&quot; /&gt;</span>
        &lt;/exec&gt;
    &lt;/target&gt;</pre>
    <ul class="note">
        <li>you don't need to do anything special for the title here</li>
        <li>It just works</li>
        <li>The downside &rarr; is that</li>
    </ul>
</section>

<section class="slide arg-value">
    <pre class="prettyprint no-bottom">    &lt;exec executable=&quot;ps&quot; outputProperty=&quot;ps-output&quot;&gt;
        &lt;arg value=&quot;x&quot; /&gt;
        &lt;arg value=&quot;|&quot; /&gt;
        &lt;arg value=&quot;grep&quot; /&gt;
        &lt;arg value=&quot;selenium&quot; /&gt;
        &lt;arg value=&quot;|&quot; /&gt;
        &lt;arg value=&quot;grep&quot; /&gt;
        &lt;arg value=&quot;-v&quot; /&gt;
        &lt;arg value=&quot;grep&quot; /&gt;
        &lt;arg value=&quot;|&quot; /&gt;
        &lt;arg value=&quot;grep&quot; /&gt;
        &lt;arg value=&quot;-v&quot; /&gt;
        &lt;arg value=&quot;phing&quot; /&gt;
    &lt;/exec&gt;</pre>
    <ul class="note">
        <li>... is that if you want to string together a bunch of commands</li>
        <li>it very rapidly looks ugly</li>
        <li>In case you're wondering,</li>
        <li>snippet tries to check to see if selenium is running</li>
        <li>and sets a property called ps-output</li>
        <li>We'll get into that a bit more later as well</li>
    </ul>
</section>

<section class="slide">
    <pre class="prettyprint">     &lt;exec executable=&quot;ps&quot; outputProperty=&quot;ps-output&quot;&gt;
        &lt;arg line=&quot;x | grep selenium | grep -v grep | grep -v phing&quot; /&gt;
    &lt;/exec&gt;</pre>
    <ul class="note">
        <li>
            There's also arg line, which in this case is a bit easier to read
        </li>
        <li>With arg line you do have to quote any parameters with spaces</li>
        <li>Also, note that you can't mix arg line and arg value</li>
        <li>unlike crossing &rarr; the streams
    </ul>
</section>

<section class="slide cross-streams">
    <img alt="Don't cross the streams" class="centered"
        src="images/cross-the-streams.jpg">
    <ul class="note">
        <li>the streams ... which is bad unless it's good</li>
        <li>mixing arg line and arg value just doesn't work</li>
    </ul>
</section>

<section class="slide dependencies-0">
    <img alt="Jenga game falling over" class="centered" src="images/jenga.jpg">
    <ul class="note">
        <li>Let's talk about dependencies</li>
        <li>Phing allows targets to depend on other targets</li>
        <li>This lets you build your project up from smaller parts</li>
        <li>There's two ways of calling another target</li>
    </ul>
</section>

<section class="slide dependencies-1">
    <img alt="Dependency graph" class="centered"
        src="images/dependency-graph.png">
    <ul class="note">
        <li>The first is a depends attribute on a target tag</li>
        <li>There's no real limit to how deep you nest these</li>
        <li>So you can have a target depending on a target</li>
        <li>That depends on other targets</li>
        <li>And so on</li>
        <li>
            Though you do need to worry about creating an unmaintainable mess
        </li>
    </ul>
</section>

<section class="slide">
    <pre class="prettyprint">    &lt;target name=&quot;build&quot; depends=&quot;test&quot; /&gt;

    &lt;target name=&quot;coverage-html&quot; depends=&quot;require-docdir&quot;&gt;
        &lt;exec executable=&quot;phpunit&quot; passthru=&quot;true&quot;&gt;
            &lt;arg value=&quot;--coverage-html=${docdir}/coverage&quot; /&gt;
            &lt;arg value=&quot;${phpunitFlag}&quot; /&gt;
        &lt;/exec&gt;
    &lt;/target&gt;</pre>
    <ul class="note">
        <li>Here's two targets that depend on others</li>
        <li>The first one, "build", doesn't do any work on its own</li>
        <li>The second depends on the require-docdir target</li>
        <li>require-docdir gets run, and it if doesn't fail the build</li>
        <li>Then phpunit is run</li>
        <li>In this case, phpunit is building code coverage</li>
        <li>and writing it where that docdir property tells it to</li>
    </ul>
</section>

<section class="slide smaller">
    <pre class="prettyprint">     &lt;target name=&quot;require-docdir&quot;&gt;
        &lt;if&gt;
            &lt;not&gt;
                &lt;isset property=&quot;docdir&quot; /&gt;
            &lt;/not&gt;
            &lt;then&gt;
                &lt;fail message=&quot;docdir isn't set in your build.properties file&quot; /&gt;
            &lt;/then&gt;
        &lt;/if&gt;
    &lt;/target&gt;</pre>
    <ul class="note">
        <li>Here's that require-docdir target</li>
        <li>
            Basically, this is just checking to see if a property is defined
        </li>
        <li>it can be defined anywhere properties normally get defined</li>
        <li>Either in a property tag or in your build.properties file</li>
        <li>This illustrates that you can have targets that don't do work</li>
        <li>
            But they can do logic and fail a build with a descriptive message
        </li>
    </ul>
</section>

<section class="slide even-smaller">
    <pre class="prettyprint no-bottom">    &lt;property name=&quot;foo&quot; value=&quot;bar&quot; /&gt;
    &lt;target name=&quot;example&quot; depends=&quot;other-task&quot;&gt;
        &lt;phingcall target=&quot;other-task&quot;&gt;
            &lt;property name=&quot;foo&quot; value=&quot;test&quot; /&gt;
            &lt;property name=&quot;baz&quot; value=&quot;test&quot; /&gt;
        &lt;/phingcall&gt;
        &lt;phingcall target=&quot;other-task&quot; /&gt;
    &lt;/target&gt;
    &lt;target name=&quot;other-task&quot;&gt;
        &lt;echo message=&quot;${foo}&quot; /&gt;
        &lt;echo message=&quot;${baz}&quot; /&gt;
    &lt;/target&gt;</pre>
    <ul class="note">
        <li>The other way of calling another task is with phingcall</li>
        <li>The difference between dependencies and phingcall is properties</li>
        <li>If you call this example target it calls other task three times</li>
        <li>The first time is the dependency, where baz is not set</li>
        <li>
            Then it calls it with a property set inside, so baz will be set
        </li>
        <li>Note that foo is changed to test in the second example</li>
        <li>If you read the documentation it makes it sound like this...</li>
        <li>When that call finishes, any of its properties are unset</li>
        <li>So in the third call baz is also unset</li>
    </ul>
</section>

<section class="slide lazy">
    <img alt="Lazy cat" class="centered" src="images/lazy-scriptlet.jpg">
    <ul class="note">
        <li>Any of y'all ever use Make to compile stuff?</li>
        <li>One of the neat things about make is that it is lazy</li>
        <li>It only recompiles a binary if one of its source files change</li>
        <li>While in general PHP never compiles stuff,</li>
        <li>There are exceptions</li>
    </ul>
</section>

<section class="slide">
    <pre class="prettyprint">    &lt;uptodate property=&quot;css-compiled&quot; targetfile=&quot;style.css&quot;&gt;
        &lt;srcfiles dir=&quot;styles&quot; includes=&quot;**/*less&quot; /&gt;
    &lt;/uptodate&gt;</pre>
    <ul class="note">
        <li>Phing uses the uptodate tag to do these conditional tasks</li>
        <li>In this case, it's going to scan the &rarr; styles</li>
    </ul>
</section>

<section class="slide">
    <pre class="prettyprint">    &lt;uptodate property=&quot;css-compiled&quot; targetfile=&quot;style.css&quot;&gt;
        &lt;srcfiles <span class="highlight">dir=&quot;styles&quot;</span> includes=&quot;**/*less&quot; /&gt;
    &lt;/uptodate&gt;</pre>
    <ul class="note">
        <li>styles directory for any changed files</li>
        <li>only looking for files &rarr; with a less</li>
    </ul>
</section>

<section class="slide">
    <pre class="prettyprint">    &lt;uptodate property=&quot;css-compiled&quot; targetfile=&quot;style.css&quot;&gt;
        &lt;srcfiles dir=&quot;styles&quot; <span class="highlight">includes=&quot;**/*less&quot;</span> /&gt;
    &lt;/uptodate&gt;</pre>
    <ul class="note">
        <li>extension</li>
        <li>It will look at the modification time on those files</li>
        <li>And compare the most recently modified timestamp</li>
        <li>against &rarr; style.css</li>
    </ul>
</section>

<section class="slide">
    <pre class="prettyprint">    &lt;uptodate property=&quot;css-compiled&quot; <span class="highlight">targetfile=&quot;style.css&quot;</span>&gt;
        &lt;srcfiles dir=&quot;styles&quot; includes=&quot;**/*less&quot; /&gt;
    &lt;/uptodate&gt;</pre>
    <ul class="note">
        <li>style.css</li>
        <li>If style.css is newer than all of the source files</li>
        <li>it sets a &rarr; property</li>
    </ul>
</section>

<section class="slide">
    <pre class="prettyprint">    &lt;uptodate <span class="highlight">property=&quot;css-compiled&quot;</span> targetfile=&quot;style.css&quot;&gt;
        &lt;srcfiles dir=&quot;styles&quot; includes=&quot;**/*less&quot; /&gt;
    &lt;/uptodate&gt;</pre>
    <ul class="note">
        <li>property called css-compiled</li>
    </ul>
</section>

<section class="slide smaller">
    <pre class="prettyprint">    &lt;uptodate property=&quot;css-compiled&quot; targetfile=&quot;style.css&quot;&gt;
        &lt;srcfiles dir=&quot;styles&quot; includes=&quot;**/*less&quot; /&gt;
    &lt;/uptodate&gt;
    &lt;target name=&quot;compile-css&quot; <span class="highlight">unless=&quot;css-compiled&quot;</span>&gt;
        &lt;exec executable=&quot;lessc&quot; passthru=&quot;true&quot; checkreturn=&quot;true&quot;&gt;
            &lt;arg value=&quot;-x&quot; /&gt;
            &lt;arg value=&quot;styles/*.less&quot; /&gt;
            &lt;arg value=&quot;style.css&quot; /&gt;
        &lt;/exec&gt;
    &lt;/target&gt;</pre>
    <ul class="note">
        <li>Targets can use that property along with the unless attribute</li>
        <li>to decide not to run</li>
        <li>In this case, if you edit one of the less files</li>
        <li>and run the compile-css target, it will run less on them</li>
        <li>If we're up to date, it does nothing</li>
    </ul>
</section>

<section class="slide composer">
    <img alt="Composer logo" class="centered" src="images/composer.png">
    <ul class="note">
        <li>Anyone *not* using composer?</li>
    </ul>
</section>

<section class="slide">
    <pre class="prettyprint">    <span class="highlight">&lt;available property=&quot;composer-exists&quot; file=&quot;composer.phar&quot; /&gt;</span>
    &lt;target name=&quot;get-composer&quot; unless=&quot;composer-exists&quot;&gt;
        &lt;exec executable=&quot;curl&quot; output=&quot;composer.php&quot;&gt;
            &lt;arg value=&quot;-sS&quot; /&gt;
            &lt;arg value=&quot;https://getcomposer.org/installer&quot; /&gt;
            &lt;arg value=&quot;|&quot; /&gt;
            &lt;arg value=&quot;php&quot; /&gt;
        &lt;/exec&gt;
        &lt;chmod file=&quot;composer.phar&quot; perm=&quot;664&quot; /&gt;
    &lt;/target&gt;</pre>
    <ul class="note">
        <li>Here's a target that will download composer</li>
        <li>but only if it hasn't already been downloaded</li>
        <li>The available property looks for the file</li>
        <li>and sets a composer-exists property if it exists</li>
    </ul>
</section>

<section class="slide">
    <pre class="prettyprint">    &lt;available property=&quot;composer-exists&quot; file=&quot;composer.phar&quot; /&gt;
    &lt;target name=&quot;get-composer&quot; <span class="highlight">unless=&quot;composer-exists&quot;&gt;</span>
        &lt;exec executable=&quot;curl&quot; output=&quot;composer.php&quot;&gt;
            &lt;arg value=&quot;-sS&quot; /&gt;
            &lt;arg value=&quot;https://getcomposer.org/installer&quot; /&gt;
            &lt;arg value=&quot;|&quot; /&gt;
            &lt;arg value=&quot;php&quot; /&gt;
        &lt;/exec&gt;
        &lt;chmod file=&quot;composer.phar&quot; perm=&quot;664&quot; /&gt;
    &lt;/target&gt;</pre>
    <ul class="note">
        <li>The get-composer target checks the composer-exists property</li>
        <li>to decide if it's going to run or not</li>
    </ul>
</section>

<section class="slide deployment">
    <img alt="Deployment" class="centered" src="images/deployment.png">
    <div class="centered cover"></div>
    <ul class="note">
        <li>Finally, let's talk about deploying software to a server</li>
        <li>We're going to do this in a relatively platform-agnostic way</li>
        <li>So no RPMs or debs</li>
        <li>If your server system is sane, this should work</li>
        <li>If you're on Windows, I can't really help</li>
    </ul>
</section>

<section class="slide assumptions">
    <div class="centered"><span class="ass">ass</span>umptions</div>
    <ul class="note">
        <li>First, some assumptions</li>
        <li>so we don't make asses of ourselves</li>
        <li>We want to do most deploys with no downtime</li>
        <li>We want to be able to rollback quickly</li>
        <li>We're using git for version control</li>
    </ul>
</section>

<section class="slide">
    <div class="link"></div>
    <ul class="note">
        <li>In order to deploy with no real downtime</li>
        <li>we need to be able to switch between versions quickly</li>
        <li>To do that, we'll use symlinks</li>
        <li>it takes almost no time to create a symlink</li>
        <li>compared to moving directories around, which can</li>
        <li>so Apache needs to be configured to follow them</li>
    </ul>
</section>

<section class="slide security">
    <img alt="Paranoia" class="centered" src="images/security.jpg">
    <ul class="note">
        <li>You want to be secure, so I'll use scp</li>
        <li>I'm going to assume that you've got SSH keys set up</li>
        <li>And if you're suitable lazy, a good SSH config file</li>
        <li>If you're still typing your password to log in</li>
        <li>You're doing it wrong</li>
    </ul>
</section>

<section class="slide tags">
    <img alt="Tags" class="centered" src="images/tag.jpg">
    <ul class="note">
        <li>We like to tag our releases with a version number</li>
        <li>I'll show you two different ways of tagging a git repo</li>
        <li>The first is a bit manual</li>
        <li>The second is more automatic but has its own problems</li>
    </ul>
</section>

<section class="slide">
    <pre class="prettyprint">    &lt;target name=&quot;tag&quot; depends=&quot;require-version&quot;&gt;
        &lt;gittag annotate=&quot;true&quot; name=&quot;${version}&quot; repository=&quot;.&quot;
                message=&quot;Tagged version ${version}&quot; /&gt;
        &lt;gitpush repository=&quot;.&quot; tags=&quot;true&quot; quiet=&quot;true&quot; /&gt;
    &lt;/target&gt;</pre>
    <ul class="note">
        <li>require-version here is similiar to the require-docdir task</li>
        <li>Assuming you install phing with VersionControl_Git depend...</li>
        <li>This will tag the repository with the git tag you specify</li>
        <li>And push it up to your remote repository</li>
        <li>You can use whatever you want for version here</li>
        <li>like 1.2.3 or 'Return of the Jedi', it doesn't matter</li>
    </ul>
</section>

<section class="slide">
    <pre class="cli">phing-the-things$ phing tag
<span class="notice">Buildfile: /Users/Omni/Sites/phing/build.xml
 [property] Loading /Users/Omni/Sites/phing/build.properties</span>

<span class="pass">phing-the-things &gt; require-version:</span>

       <span class="fail">[if] Error in IfTask
Execution of target &quot;require-version&quot; failed for the following reason: /Users/Omni/Sites/phing/build.xml:146:12: /Users/Omni/Sites/phing/build.xml:150:18: You must pass in a version: -Dversion=1.2.3
BUILD FAILED
/Users/Omni/Sites/phing/build.xml:146:12: /Users/Omni/Sites/phing/build.xml:150:18: You must pass in a version: -Dversion=1.2.3
Total time: 1.5921 second</span></pre>
    <ul class="note">
        <li>Here's what you might see if you don't include the version</li>
        <li>You can see the build failed, and there's a message</li>
        <li>Saying that you must include the version parameter</li>
    </ul>
</section>

<section class="slide">
    <pre class="cli">phing-the-things$ phing tag-no-version
<span class="info">Buildfile: /Users/Omni/Sites/phing/build.xml
 [property] Loading /Users/Omni/Sites/phing/build.properties</span>

<span class="pass">phing-the-things &gt; tag-no-version:</span>

   <span class="notice">[gittag] git-tag command: /usr/bin/git tag -a -m'Tagged version ${version}' '${version}'
   [gittag] git-tag: tags for &quot;.&quot; repository
   [gittag] git-tag output:</span>

<span class="pass">BUILD FINISHED

Total time: 0.2039 seconds</span>

phing-the-things $ git tag
${version}</pre>
    <ul class="note">
        <li>I feel like this is much better than tagging with garbage</li>
        <li>Here's what happens if you tag without passing in a version</li>
        <li>And you don't check to see if version is passed in</li>
        <li>It doesn't fail, but it does put in a garbage tag</li>
    </ul>
</section>

<section class="slide version">
    <pre class="prettyprint no-bottom">    &lt;target name=&quot;tag-version&quot;&gt;
        <span class="highlight">&lt;version releasetype=&quot;${release}&quot; file=&quot;version.txt&quot; property=&quot;version&quot; /&gt;</span>
        &lt;exec executable=&quot;git&quot; passthru=&quot;true&quot;&gt;
            &lt;arg line=&quot;add version.txt&quot; /&gt;
        &lt;/exec&gt;
        &lt;exec executable=&quot;git&quot; passthru=&quot;true&quot;&gt;
            &lt;arg line=&quot;commit -m 'Updated version file to ${version}'&quot; /&gt;
        &lt;/exec&gt;
        &lt;gittag annotate=&quot;true&quot; name=&quot;${version}&quot; repository=&quot;.&quot;
                message=&quot;Tagged version ${version}&quot; /&gt;
    &lt;/target&gt;</pre>
    <ul class="note">
        <li>Phing supports automagic incrementing versions</li>
        <li>with the version tag</li>
        <li>The version tag takes three attributes</li>
        <li>The first is &rarr; releasetype</li>
    </ul>
</section>

<section class="slide version">
    <pre class="prettyprint">    &lt;target name=&quot;tag-version&quot;&gt;
        &lt;version <span class="highlight">releasetype=&quot;${release}&quot;</span> file=&quot;version.txt&quot; property=&quot;version&quot; /&gt;
        &lt;exec executable=&quot;git&quot; passthru=&quot;true&quot;&gt;
            &lt;arg line=&quot;add version.txt&quot; /&gt;
        &lt;/exec&gt;
        &lt;exec executable=&quot;git&quot; passthru=&quot;true&quot;&gt;
            &lt;arg line=&quot;commit -m 'Updated version file to ${version}'&quot; /&gt;
        &lt;/exec&gt;
        &lt;gittag annotate=&quot;true&quot; name=&quot;${version}&quot; repository=&quot;.&quot;
                message=&quot;Tagged version ${version}&quot; /&gt;
    &lt;/target&gt;</pre>
    <ul class="note">
        <li>release type</li>
        <li>This can be Major, Minor, or BugFix</li>
    </ul>
</section>

<section class="slide version">
    <pre class="prettyprint">    &lt;target name=&quot;tag-version&quot;&gt;
        &lt;version releasetype=&quot;${release}&quot; <span class="highlight">file=&quot;version.txt&quot;</span> property=&quot;version&quot; /&gt;
        &lt;exec executable=&quot;git&quot; passthru=&quot;true&quot;&gt;
            &lt;arg line=&quot;add version.txt&quot; /&gt;
        &lt;/exec&gt;
        &lt;exec executable=&quot;git&quot; passthru=&quot;true&quot;&gt;
            &lt;arg line=&quot;commit -m 'Updated version file to ${version}'&quot; /&gt;
        &lt;/exec&gt;
        &lt;gittag annotate=&quot;true&quot; name=&quot;${version}&quot; repository=&quot;.&quot;
                message=&quot;Tagged version ${version}&quot; /&gt;
    &lt;/target&gt;</pre>
    <ul class="note">
        <li>The file attribute names a file that holds the current version</li>
        <li>The version number must be in major dot minor dot patchlevel</li>
        <li>The file either needs to be in your source control</li>
        <li>and thus updated every release</li>
        <li>or ignored and then you can get out of sync really easy</li>
    </ul>
</section>

<section class="slide version">
    <pre class="prettyprint">    &lt;target name=&quot;tag-version&quot;&gt;
        &lt;version releasetype=&quot;${release}&quot; file=&quot;version.txt&quot; <span class="highlight">property=&quot;version&quot;</span> /&gt;
        &lt;exec executable=&quot;git&quot; passthru=&quot;true&quot;&gt;
            &lt;arg line=&quot;add version.txt&quot; /&gt;
        &lt;/exec&gt;
        &lt;exec executable=&quot;git&quot; passthru=&quot;true&quot;&gt;
            &lt;arg line=&quot;commit -m 'Updated version file to ${version}'&quot; /&gt;
        &lt;/exec&gt;
        &lt;gittag annotate=&quot;true&quot; name=&quot;${version}&quot; repository=&quot;.&quot;
                message=&quot;Tagged version ${version}&quot; /&gt;
    &lt;/target&gt;</pre>
    <ul class="note">
        <li>Finally, there's the property attribute</li>
        <li>The version that gets incremented is stored in this property</li>
        <li>You can then use it for whatever you want</li>
    </ul>
</section>

<section class="slide version">
    <pre class="prettyprint">    &lt;target name=&quot;tag-version&quot;&gt;
        &lt;version releasetype=&quot;${release}&quot; file=&quot;version.txt&quot; property=&quot;version&quot; /&gt;
        &lt;exec executable=&quot;git&quot; passthru=&quot;true&quot;&gt;
            &lt;arg line=&quot;add version.txt&quot; /&gt;
        &lt;/exec&gt;
        &lt;exec executable=&quot;git&quot; passthru=&quot;true&quot;&gt;
            &lt;arg line=&quot;commit -m 'Updated version file to ${version}'&quot; /&gt;
        &lt;/exec&gt;
        &lt;gittag annotate=&quot;true&quot; name=&quot;${version}&quot; repository=&quot;.&quot;
                message=&quot;Tagged version ${version}&quot; /&gt;
    &lt;/target&gt;</pre>
    <ul class="note">
        <li>After the version file gets updated, we stage it and commit it</li>
        <li>Then tag our repository</li>
    </ul>
</section>

<section class="slide">
    <pre class="cli">phing-the-things$ phing tag-version -Drelease=minor
<span class="notice">Buildfile: /Users/Omni/Sites/phing/build.xml
 [property] Loading /Users/Omni/Sites/phing/build.properties</span>
<span class="pass">phing-the-things &gt; tag-version:</span>

[master 4b48e9f] Updated version file to 0.1.0
 1 file changed, 1 insertion(+), 1 deletion(-)
   <span class="notice">[gittag] git-tag command: /usr/bin/git tag -a -m'Tagged version 0.1.0' '0.1.0'
   [gittag] git-tag: tags for "." repository
   [gittag] git-tag output:</span>

<span class="pass">BUILD FINISHED
Total time: 0.3507 seconds</span>

phing-the-things $ git tag
0.0.1
0.1.0</pre>
    <ul class="note">
        <li>Here's what the output might look like</li>
        <li>I'm updating the minor version from 0.0.1</li>
        <li>Phing figures out that the next minor version is 0.1.0</li>
    </ul>
</section>

<section class="slide">
    <pre class="prettyprint">    &lt;target name=&quot;release-major&quot;&gt;
        &lt;phingcall target=&quot;tag-version&quot;&gt;
            &lt;property name=&quot;release&quot; value=&quot;major&quot; /&gt;
        &lt;/phingcall&gt;
    &lt;/target&gt;
    &lt;target name=&quot;release-minor&quot;&gt;
        &lt;phingcall target=&quot;tag-version&quot;&gt;
            &lt;property name=&quot;release&quot; value=&quot;minor&quot; /&gt;
        &lt;/phingcall&gt;
    &lt;/target&gt;</pre>
    <ul class="note">
        <li>If you don't want to pass things in on the command line</li>
        <li>setting up full targets to do these sorts of things is easy</li>
        <li>But I'm going to stick with command line arguments</li>
    </ul>
</section>

<section class="slide">
    <pre class="prettyprint">    &lt;target name=&quot;tag-svn&quot;&gt;
        &lt;svncopy svnpath=&quot;${svnpath}&quot; username=&quot;${svnuser}&quot;
            password=&quot;${svnpass}&quot; nocache=&quot;true&quot;
            repositoryurl=&quot;svn://localhost/phing-the-things/trunk/&quot;
            todir=&quot;svn://localhost/phing-the-things/tags/${version}&quot; /&gt;
    &lt;/target&gt;</pre>
    <ul class="note">
        <li>For you Subversive types, here's a similar command for tagging</li>
        <li>Not quite as pretty as gittag</li>
        <li>but most Subversion things aren't as pretty as git counterparts</li>
    </ul>
</section>

<section class="slide smaller">
    <pre class="prettyprint">
    &lt;target name=&quot;tag-version-no-file&quot;&gt;
        &lt;exec executable=&quot;git&quot; outputProperty=&quot;latest-version&quot;&gt;
            &lt;arg line=&quot;tag | sort -t. -k 1,1n -k 2,2n -k 3,3n | tail -1&quot; /&gt;
        &lt;/exec&gt;
        &lt;echo file=&quot;v.txt&quot;&gt;${latest-version}&lt;/echo&gt;
        &lt;version releasetype=&quot;${release}&quot; file=&quot;v.txt&quot; property=&quot;version&quot; /&gt;
        &lt;delete file=&quot;v.txt&quot; /&gt;
        &lt;gittag annotate=&quot;true&quot; name=&quot;${version}&quot; repository=&quot;.&quot;
                    message=&quot;Tagged version ${version}&quot; /&gt;
    &lt;/target&gt;</pre>
    <ul class="note">
        <li>Back to git</li>
        <li>Let's say you wanted to be able to use the version task</li>
        <li>But don't want that pesky file hanging out</li>
        <li>This asks git for the most recent tag</li>
        <li>All of that sorting is so you get the highest version</li>
        <li>Since otherwise you get version 1.1.11 being before 1.1.2</li>
        <li>Stores it in version.txt</li>
        <li>Increments the version, deletes the file, and then tags git</li>
        <li>This is really just an example of the complex behavior</li>
        <li>from a few simple primatives</li>
    </ul>
</section>

<section class="slide smaller">
    <pre class="prettyprint">    &lt;property name=&quot;build-url&quot;
            value=&quot;https://jenkins/job/phing/lastBuild/api/json?pretty=true&quot; /&gt;
    &lt;target name=&quot;require-green-build-check&quot;&gt;
        &lt;exec executable=&quot;curl&quot; outputProperty=&quot;build-status&quot;&gt;
            &lt;arg line='--silent ${build-url} | grep result | cut -d&quot; -f4' /&gt;
        &lt;/exec&gt;
        &lt;if&gt;
            &lt;not&gt;&lt;equals arg1=&quot;${build-status}&quot; arg2=&quot;SUCCESS&quot; /&gt;&lt;/not&gt;
            &lt;then&gt;&lt;fail message=&quot;Jenkins build is broken&quot; /&gt;&lt;/then&gt;
        &lt;/if&gt;
    &lt;/target&gt;</pre>
    <ul class="note">
        <li>Here's a fun dependency for your release process</li>
        <li>This uses curl to ask Jenkins if your build is broken</li>
        <li>Broken builds mean you definitely shouldn't release</li>
        <li>And this fails your phing task</li>
        <li>It does some simple command line parsing of the status JSON</li>
        <li>You could do more there, like output the name of who broke it</li>
        <li>Nothing changes the behavior of carbon-based meat popsicles...</li>
    </ul>
</section>

<section class="slide">
    <pre class="prettyprint">
    &lt;target name=&quot;deploy&quot;&gt;
        &lt;phingcall target=&quot;require-release&quot; /&gt;
        &lt;phingcall target=&quot;require-green-build-check&quot; /&gt;
        &lt;phingcall target=&quot;tag-version-no-file&quot; /&gt;
    &lt;/target&gt;</pre>
    <ul class="note">
        <li>Here's our deployment task so far</li>
        <li>We require the user to pass in a release</li>
        <li>We require the build to be green</li>
        <li>And we tag the new version</li>
        <li>If I wasn't projecting this I would do it slightly differently</li>
        <li>Both of the require calls would be a depends attribute</li>
        <li>Instead of phingcalls, purely for aesthetic reasons</li>
    </ul>
</section>

<section class="slide prepare">
    <img alt="Prepare yourself - Deployment is coming" class="centered"
            src="images/prepare-yourself.jpg">
    <ul class="note">
        <li>Before we deploy, we're going to prepare a tarball</li>
        <li>And instead of just using the current checkout</li>
        <li>We'll get a clean clone and remove some stuff</li>
        <li>There's no reason to upload your unit tests or git directories</li>
    </ul>
</section>

<section class="slide smaller">
    <pre class="prettyprint">    &lt;target name=&quot;prepare&quot;&gt;
        &lt;gitclone repository=&quot;git://gitserver/repos/phing-the-things.git&quot;
                targetPath=&quot;build&quot; /&gt;
        &lt;gitcheckout repository=&quot;build&quot; branchname=&quot;${version}&quot; quiet=&quot;true&quot; /&gt;
        &lt;delete dir=&quot;build/tests&quot; /&gt;
        &lt;delete file=&quot;build/build.xml&quot; /&gt;
        &lt;tar destfile=&quot;build-${version}.tar.bz2&quot; basedir=&quot;build&quot;
                includeemptydir=&quot;true&quot; compression=&quot;bzip2&quot; /&gt;
        &lt;delete dir=&quot;build&quot; /&gt;
    &lt;/target&gt;</pre>
    <ul class="note">
        <li>Here's a prepare target</li>
        <li>We're going to grab the clean clone first</li>
        <li>This makes sure that we don't deploy any in progress code</li>
        <li>We change over to our newly created tag</li>
        <li>We delete the tests directory and the build file</li>
        <li>Then we tar and compress it</li>
        <li>Finally we delete the build directory</li>
    </ul>
</section>

<section class="slide">
    <pre class="prettyprint">
    &lt;target name=&quot;deploy&quot;&gt;
        &lt;phingcall target=&quot;require-release&quot; /&gt;
        &lt;phingcall target=&quot;require-green-build-check&quot; /&gt;
        &lt;phingcall target=&quot;tag-version-no-file&quot; /&gt;
        &lt;phingcall target=&quot;prepare&quot; /&gt;
    &lt;/target&gt;</pre>
    <ul class="note">
        <li>Our updated deployment is starting to take shape</li>
        <li>Already we've made deployments easier and more repeatable</li>
        <li>Your prepare task might also concatenate and minimize</li>
        <li>or compile things</li>
        <li>Whatever you need</li>
    </li>
</section>

<section class="slide smaller">
    <pre class="prettyprint">    &lt;target name=&quot;upload&quot;&gt;
        &lt;exec executable=&quot;scp&quot; checkreturn=&quot;true&quot;&gt;
            &lt;arg value=&quot;build-${version}.tar.bz2&quot; /&gt;
            &lt;arg value=&quot;${server}:/var/www/&quot; /&gt;
        &lt;/exec&gt;
        &lt;exec executable=&quot;ssh&quot; checkreturn=&quot;true&quot; passthru=&quot;true&quot;&gt;
            &lt;arg value=&quot;${server}&quot; /&gt;
            &lt;arg value=&quot;cd /var/www ; tar -xjf build-${version}.tar.bz2&quot; /&gt;
        &lt;/exec&gt;
    &lt;/target&gt;</pre>
    <ul class="note">
        <li>Next we have an upload target</li>
        <li>These use scp to upload the tarball</li>
        <li>and ssh to uncompress it</li>
        <li>There are native SSH and scp tasks, but they require a pecl...</li>
        <li>Note that you can use sudo over ssh if you need to</li>
        <li>You'll want to add the -t argument</li>
        <li>that forces SSH to use a pseudo-TTY so you can enter your pass</li>
        <li>at this point, depending on your app, you can sanity check</li>
    </ul>
</section>

<section class="slide">
    <pre class="prettyprint">
    &lt;target name=&quot;deploy&quot;&gt;
        &lt;phingcall target=&quot;require-release&quot; /&gt;
        &lt;phingcall target=&quot;require-green-build-check&quot; /&gt;
        &lt;phingcall target=&quot;tag-version-no-file&quot; /&gt;
        &lt;phingcall target=&quot;prepare&quot; /&gt;
        &lt;phingcall target=&quot;upload&quot; /&gt;
    &lt;/target&gt;</pre>
    <ul class="note">
        <li>We're almost there!</li>
        <li>Now we just need to change our symlinks</li>
        <li>At first you might be tempted to include this in the previous ssh</li>
        <li>I prefer it as a different task to make rollbacks easy</li>
    </li>
</section>

<section class="slide">
    <pre class="prettyprint">
    &lt;target name=&quot;go-live&quot; depends=&quot;require-version&quot;&gt;
        &lt;exec executable=&quot;ssh&quot; checkreturn=&quot;true&quot; passthru=&quot;true&quot;&gt;
            &lt;arg value=&quot;${server}&quot; /&gt;
            &lt;arg value=&quot;cd /var/www; ln -sf build-${version} app&quot; /&gt;
        &lt;/exec&gt;
    &lt;/target&gt;</pre>
    <ul class="note">
        <li>The final step of deployments</li>
        <li>We ssh to the server again</li>
        <li>and replace the symlink to point to our new version</li>
        <li>Our old deployment is still there, it just isn't linked</li>
        <li>In this case, we assume Apache is pointing a /var/www/app</li>
        <li>Just changing a symlink == instantaneous</li>
    </ul>
</section>

<section class="slide">
    <pre class="prettyprint">
    &lt;target name=&quot;deploy&quot;&gt;
        &lt;phingcall target=&quot;require-release&quot; /&gt;
        &lt;phingcall target=&quot;require-green-build-check&quot; /&gt;
        &lt;phingcall target=&quot;tag-version-no-file&quot; /&gt;
        &lt;phingcall target=&quot;prepare&quot; /&gt;
        &lt;phingcall target=&quot;upload&quot; /&gt;
        &lt;phingcall target=&quot;go-live&quot; /&gt;
    &lt;/target&gt;</pre>
    <ul class="note">
        <li>Our final full deployment target</li>
        <li>Lots of small and simple individual targets</li>
    </ul>
</section>

<section class="slide sanity-check">
    <div class="centered sanity">sanity</div>
    <div class="centered check">check</div>
    <ul class="note">
        <li>Now you need to sanity check it</li>
        <li>If you've got good smoke tests you can run them now</li>
        <li>otherwise, open up your browser and make sure things are good</li>
    </ul>
</section>

<section class="slide sanity-check-fail">
    <img alt="Computer says no" class="centered"
            src="images/computer-says-no.jpg">
    <ul class="note">
        <li>So what if you notice a problem in your shiny new build?</li>
        <li>Since we split the go-live target out from the upload target</li>
        <li>It's really easy to roll back</li>
    </ul>
</section>

<section class="slide">
    <pre class="cli">phing-the-things$ phing go-live -Dversion=1.2.3</pre>
    <ul class="note">
        <li>Your go-live target accepts a version number</li>
        <li>So just give it your last known good version</li>
    </ul>
</section>

<section class="slide backpedal">
    <pre class="cli">phing-the-things$ phing go-live -Dversion=1.2.3</pre>
    <img alt="Cat backpedalling" class="centered" src="images/backpedal.jpg">
    <ul class="note">
        <li>This kind of makes it your get out of jail free card</li>
    </ul>
</section>

<section class="slide about-me">
    <div class="centered">
        <img alt="Omni Adams" class="pull-left" src="images/omni-simpson.jpg">
        <ul class="pull-right">
            <li>Omni Adams</li>
            <li>@omnicolor</li>
            <li>http://omni-spot.blogspot.com</li>
            <li>omni@digitaldarkness.com</li>
        </ul>
    </div>
    <ul class="note">
        <li>Thank y'all</li>
        <li>Any questions?</li>
    </ul>
</section>

<!--
<section class="slide">
    <pre class="prettyprint">
    </pre>
    <ul class="note">
    </ul>
</section>
-->

<p class="deck-status">
	<span class="deck-status-current"></span>
	/
	<span class="deck-status-total"></span>
</p>

<script src="deck.js/jquery-1.7.2.min.js"></script>
<script src="deck.js/core/deck.core.js"></script>
<script src="deck.js/extensions/status/deck.status.js"></script>
<script src="deck.js/extensions/hash/deck.hash.js"></script>
<script src="google-code-prettify/src/prettify.js"></script>
<script src="phing.js"></script>
</body>
</html>
